{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _extends from \"@babel/runtime/helpers/esm/extends\";\nimport _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime/helpers/esm/inherits\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nvar _jsxFileName = \"/Users/bishwas/Documents/workplace/SoftwareArchitecture/MERN_ECOMMERCE_APP/pages/_app.js\";\nimport React from \"react\";\nvar __jsx = React.createElement;\n\nfunction _createSuper(Derived) { return function () { var Super = _getPrototypeOf(Derived), result; if (_isNativeReflectConstruct()) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }\n\nimport App from \"next/app\";\nimport Layout from \"../components/_App/Layout\";\nimport { parseCookies, destroyCookie } from \"nookies\";\nimport { redirectUser } from \"../utils/auth\";\nimport baseUrl from \"../utils/baseUrl\";\nimport axios from \"axios\";\nimport { Router } from \"next/router\";\n\nvar MyApp = /*#__PURE__*/function (_App) {\n  _inherits(MyApp, _App);\n\n  var _super = _createSuper(MyApp);\n\n  function MyApp() {\n    var _this;\n\n    _classCallCheck(this, MyApp);\n\n    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n\n    _this = _super.call.apply(_super, [this].concat(args));\n\n    _defineProperty(_assertThisInitialized(_this), \"synclogout\", function (event) {\n      if (event.key === 'logout') {\n        Router.push('/login');\n      }\n    });\n\n    return _this;\n  }\n\n  _createClass(MyApp, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      window.addEventListener('storage', this.synclogout);\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this$props = this.props,\n          Component = _this$props.Component,\n          pageProps = _this$props.pageProps;\n      return __jsx(Layout, _extends({}, pageProps, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 61,\n          columnNumber: 7\n        }\n      }), __jsx(Component, _extends({}, pageProps, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 62,\n          columnNumber: 10\n        }\n      })));\n    }\n  }], [{\n    key: \"getInitialProps\",\n    value: function getInitialProps(_ref) {\n      var Component, ctx, _parseCookies, token, pageProps, isProtectedRoute, payload, url, response, user, isRoot, isAdmin;\n\n      return _regeneratorRuntime.async(function getInitialProps$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              Component = _ref.Component, ctx = _ref.ctx;\n              _parseCookies = parseCookies(ctx), token = _parseCookies.token;\n              pageProps = {};\n\n              if (!Component.getInitialProps) {\n                _context.next = 7;\n                break;\n              }\n\n              _context.next = 6;\n              return _regeneratorRuntime.awrap(Component.getInitialProps(ctx));\n\n            case 6:\n              pageProps = _context.sent;\n\n            case 7:\n              if (token) {\n                _context.next = 12;\n                break;\n              }\n\n              isProtectedRoute = ctx.pathname === '/account' || ctx === '/create';\n\n              if (isProtectedRoute) {\n                redirectUser(ctx, '/login');\n              }\n\n              _context.next = 31;\n              break;\n\n            case 12:\n              _context.prev = 12;\n              payload = {\n                headers: {\n                  Authorization: token\n                }\n              };\n              url = \"\".concat(baseUrl, \"/api/account\");\n              _context.next = 17;\n              return _regeneratorRuntime.awrap(axios.get(url, payload));\n\n            case 17:\n              response = _context.sent;\n              user = response.data;\n              isRoot = user.role === 'root';\n              isAdmin = user.role === 'admin';\n              if (!(isAdmin || isRoot) && ctx.pathname === '/create') redirectUser(ctx, '/');\n              pageProps.user = user;\n              console.log(\"TEST   +++ \" + user);\n              _context.next = 31;\n              break;\n\n            case 26:\n              _context.prev = 26;\n              _context.t0 = _context[\"catch\"](12);\n              console.log(\"Error : \" + _context.t0);\n              destroyCookie(ctx, 'token');\n              redirectUser(ctx, '/login');\n\n            case 31:\n              return _context.abrupt(\"return\", {\n                pageProps: pageProps\n              });\n\n            case 32:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, null, null, [[12, 26]], Promise);\n    }\n  }]);\n\n  return MyApp;\n}(App);\n\nexport default MyApp;","map":{"version":3,"sources":["/Users/bishwas/Documents/workplace/SoftwareArchitecture/MERN_ECOMMERCE_APP/pages/_app.js"],"names":["App","Layout","parseCookies","destroyCookie","redirectUser","baseUrl","axios","Router","MyApp","event","key","push","window","addEventListener","synclogout","props","Component","pageProps","ctx","token","getInitialProps","isProtectedRoute","pathname","payload","headers","Authorization","url","get","response","user","data","isRoot","role","isAdmin","console","log"],"mappings":";;;;;;;;;;;;;;;;;AAAA,OAAOA,GAAP,MAAgB,UAAhB;AACA,OAAOC,MAAP,MAAmB,2BAAnB;AACA,SAASC,YAAT,EAAsBC,aAAtB,QAA2C,SAA3C;AACA,SAASC,YAAT,QAA6B,eAA7B;AACA,OAAOC,OAAP,MAAoB,kBAApB;AACA,OAAOC,KAAP,MAAkB,OAAlB;AACA,SAASC,MAAT,QAAuB,aAAvB;;IAGMC,K;;;;;;;;;;;;;;;;iEAwCO,UAAAC,KAAK,EAAE;AAChB,UAAGA,KAAK,CAACC,GAAN,KAAY,QAAf,EAAwB;AACtBH,QAAAA,MAAM,CAACI,IAAP,CAAY,QAAZ;AAED;AAEF,K;;;;;;;wCATkB;AACjBC,MAAAA,MAAM,CAACC,gBAAP,CAAwB,SAAxB,EAAkC,KAAKC,UAAvC;AACD;;;6BASQ;AAAA,wBACyB,KAAKC,KAD9B;AAAA,UACCC,SADD,eACCA,SADD;AAAA,UACWC,SADX,eACWA,SADX;AAEP,aACE,MAAC,MAAD,eAAYA,SAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UACG,MAAC,SAAD,eAAeA,SAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SADH,CADF;AAKD;;;;;;;;;;AArD6BD,cAAAA,S,QAAAA,S,EAAUE,G,QAAAA,G;8BACxBhB,YAAY,CAACgB,GAAD,C,EAAnBC,K,iBAAAA,K;AACHF,cAAAA,S,GAAU,E;;mBACXD,SAAS,CAACI,e;;;;;;+CACKJ,SAAS,CAACI,eAAV,CAA0BF,GAA1B,C;;;AAAhBD,cAAAA,S;;;kBAEEE,K;;;;;AACIE,cAAAA,gB,GAAiBH,GAAG,CAACI,QAAJ,KAAe,UAAf,IAA6BJ,GAAG,KAAG,S;;AAC1D,kBAAGG,gBAAH,EAAoB;AAClBjB,gBAAAA,YAAY,CAACc,GAAD,EAAK,QAAL,CAAZ;AACD;;;;;;;AAIOK,cAAAA,O,GAAQ;AAACC,gBAAAA,OAAO,EAAC;AAACC,kBAAAA,aAAa,EAACN;AAAf;AAAT,e;AACRO,cAAAA,G,aAAOrB,O;;+CACUC,KAAK,CAACqB,GAAN,CAAUD,GAAV,EAAcH,OAAd,C;;;AAAjBK,cAAAA,Q;AACAC,cAAAA,I,GAAKD,QAAQ,CAACE,I;AACdC,cAAAA,M,GAAOF,IAAI,CAACG,IAAL,KAAY,M;AACnBC,cAAAA,O,GAAQJ,IAAI,CAACG,IAAL,KAAY,O;AAC1B,kBAAG,EAAEC,OAAO,IAAIF,MAAb,KAAwBb,GAAG,CAACI,QAAJ,KAAe,SAA1C,EACIlB,YAAY,CAACc,GAAD,EAAK,GAAL,CAAZ;AAGJD,cAAAA,SAAS,CAACY,IAAV,GAAeA,IAAf;AACAK,cAAAA,OAAO,CAACC,GAAR,CAAY,gBAAcN,IAA1B;;;;;;;AAGCK,cAAAA,OAAO,CAACC,GAAR,CAAY,wBAAZ;AACAhC,cAAAA,aAAa,CAACe,GAAD,EAAK,OAAL,CAAb;AACAd,cAAAA,YAAY,CAACc,GAAD,EAAK,QAAL,CAAZ;;;+CAGC;AAACD,gBAAAA,SAAS,EAATA;AAAD,e;;;;;;;;;;;;EAnCUjB,G;;AA0DpB,eAAeQ,KAAf","sourcesContent":["import App from \"next/app\";\nimport Layout from \"../components/_App/Layout\";\nimport { parseCookies,destroyCookie } from \"nookies\";\nimport { redirectUser } from \"../utils/auth\";\nimport baseUrl from \"../utils/baseUrl\";\nimport axios from \"axios\";\nimport { Router } from \"next/router\";\n\n\nclass MyApp extends App {\n\n  static async getInitialProps({Component,ctx}){\n    const {token}=parseCookies(ctx);\n    let pageProps={};\n    if(Component.getInitialProps){\n      pageProps=await Component.getInitialProps(ctx)\n    }\n    if(!token){\n      const isProtectedRoute=ctx.pathname==='/account' || ctx==='/create';\n      if(isProtectedRoute){\n        redirectUser(ctx,'/login');\n      }\n    }\n    else{\n      try{\n        const payload={headers:{Authorization:token}};\n        const url=`${baseUrl}/api/account`;\n        const response = await axios.get(url,payload);\n        const user=response.data;\n        const isRoot=user.role==='root';\n        const isAdmin=user.role==='admin';\n        if(!(isAdmin || isRoot) && ctx.pathname==='/create')\n            redirectUser(ctx,'/');\n\n       \n        pageProps.user=user;\n        console.log(\"TEST   +++ \"+user);\n      }\n      catch(error){\n         console.log(\"Error : \"+error);\n         destroyCookie(ctx,'token');\n         redirectUser(ctx,'/login')\n      }\n    }\n   return {pageProps};\n  }\n  componentDidMount(){\n    window.addEventListener('storage',this.synclogout);\n  }\n  synclogout=event=>{\n    if(event.key==='logout'){\n      Router.push('/login');\n\n    }\n\n  }\n\n  render() {\n    const { Component,pageProps } = this.props;\n    return (\n      <Layout {...pageProps}>\n         <Component {...pageProps}/>\n      </Layout>\n    );\n  }\n}\n\nexport default MyApp;\n"]},"metadata":{},"sourceType":"module"}